<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>Royal Spice Admin</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>

body{
  margin:0;
  font-family:Poppins;
  background:radial-gradient(circle at top left,#1e232b,#0d0f13 60%);
  color:#eee;
}

/* HEADER */

@media (max-width:768px){

.header{
    padding:20px;
  }

 .title{
  font-size:28px;
  font-weight:600;
  letter-spacing:1px;
}

  .logout{
    position:static;
    transform:none;
    margin-top:15px;
  }

}
.header{
  position:relative;
  padding:25px 60px;
  backdrop-filter:blur(18px);
  background:rgba(255,255,255,.04);
  border-bottom:1px solid rgba(255,255,255,.08);
  text-align:center;
}

.title{
  font-size:26px;
  font-weight:600;
  letter-spacing:.5px;
}
#liveCount{
  margin:10px auto 0;
  font-size:14px;
  opacity:.9;
  background:rgba(255,255,255,.05);
  padding:8px 16px;
  border-radius:30px;
  display:inline-block;
}

.title span{
  color:#d4af37; /* gold */
}

/* LOGOUT */

.logout{
  position:absolute;
  right:60px;
  top:50%;
  transform:translateY(-50%);
  background:transparent;
  border:1px solid rgba(255,255,255,.2);
  color:#eee;
  padding:8px 18px;
  border-radius:10px;
  cursor:pointer;
  transition:.25s;
}

.logout:hover{
  border-color:#d4af37;
  color:#d4af37;
}

#orders{
  padding:40px 60px;
  display:grid;
  grid-template-columns:repeat(auto-fill, minmax(320px, 1fr));
  gap:30px;
  max-width:1400px;
  margin:auto;
}
/* ORDER CARD */

.card{
  padding:22px;
  border-radius:18px;
  background:linear-gradient(
    145deg,
    rgba(255,255,255,.06),
    rgba(255,255,255,.02)
  );
  backdrop-filter:blur(14px);
  box-shadow:0 10px 30px rgba(0,0,0,.6);

  min-height:320px;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}
.card:hover{
  transform:translateY(-6px);
  transition:.3s;
}

.orderId{
  color:#d4af37;
  font-weight:600;
  margin-bottom:10px;
}

.item{
  font-size:14px;
  margin-left:6px;
  opacity:.85;
}

.total{
  margin-top:12px;
  font-weight:600;
}

/* SELECT */

select{
  margin-top:15px;
  width:100%;
  padding:10px;
  border-radius:10px;
  border:none;
  background:#111;
  color:#fff;
}

/* DELETE */

.delete{
  margin-top:12px;
  width:100%;
  padding:10px;
  border:none;
  border-radius:10px;
  background:#2a0f0f;
  color:#ffb3b3;
  cursor:pointer;
}
/* ===== MODAL BACKDROP ===== */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.65);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;
}

/* ===== MODAL CARD ===== */
.modal-card{
  width:340px;
  padding:28px;
  border-radius:18px;
  background:linear-gradient(
    145deg,
    rgba(255,255,255,.08),
    rgba(255,255,255,.03)
  );
  backdrop-filter:blur(18px);
  box-shadow:0 20px 40px rgba(0,0,0,.6);
  text-align:center;
}

.modal-card h3{
  margin:0 0 8px;
  color:#d4af37;
}

.modal-card p{
  font-size:14px;
  opacity:.8;
}

/* ACTION BUTTONS */
.modal-actions{
  display:flex;
  gap:12px;
  margin-top:20px;
}

.cancel-btn{
  flex:1;
  background:#222;
  color:#ccc;
  border:none;
  padding:10px;
  border-radius:10px;
  cursor:pointer;
}

.danger-btn{
  flex:1;
  background:linear-gradient(135deg,#8b0000,#ff4d4d);
  color:#fff;
  border:none;
  padding:10px;
  border-radius:10px;
  cursor:pointer;
}

.danger-btn:hover{
  box-shadow:0 10px 20px rgba(255,77,77,.4);
}

.delete:hover{
  background:#3a1414;
}

</style>
</head>
<!-- LOGIN PROTECTION -->

<body>
  <script>
history.pushState(null, null, location.href);
window.onpopstate = function () {
  history.go(1);
};
</script>

<script>
function checkAuth(){
  if(sessionStorage.getItem("adminLoggedIn") !== "true"){
    window.location.replace("login.html");
  }
}

// Run immediately
checkAuth();

// ðŸ”¥ Force reload if coming from back/forward cache
window.addEventListener("pageshow", function (event) {
  if (event.persisted) {
    window.location.reload();
  }
});
</script>
<div class="header">
  <div class="title">Royal Spice <span>Admin</span></div>

  <div id="adminInfo"></div>

  <div id="liveCount"></div>

  <button class="logout" onclick="logout()">Logout</button>
</div>

<div id="orders"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
  getFirestore,
  collection,
  onSnapshot,
  doc,
  updateDoc,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCPWXEztAyRqOQaFRIJVZJtBU2TINCE_4A",
  authDomain: "biriyani-app-7f501.firebaseapp.com",
  projectId: "biriyani-app-7f501",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const ordersDiv = document.getElementById("orders");

onSnapshot(collection(db,"orders"), snapshot=>{

  ordersDiv.innerHTML = "";   // ðŸ”¥ CLEAR OLD DATA FIRST

  let total = snapshot.size;
  let delivered = 0;

  snapshot.forEach(d=>{

    const o = d.data();

    if(o.status === "Delivered"){
      delivered++;
    }

    let itemsHTML="";
    for(let i in o.items){
      itemsHTML+=`<div class="item">â€¢ ${i} Ã— ${o.items[i].qty}</div>`;
    }

    ordersDiv.innerHTML+=`
      <div class="card">
        <div class="orderId">Order #${o.orderId}</div>

        ${itemsHTML}

        <div class="total">Total: â‚¹${o.total}</div>

        <select onchange="updateStatus('${d.id}',this.value)">
          <option ${o.status=="Placed"?"selected":""}>Placed</option>
          <option ${o.status=="Preparing"?"selected":""}>Preparing</option>
          <option ${o.status=="Ready"?"selected":""}>Ready</option>
          <option ${o.status=="Delivered"?"selected":""}>Delivered</option>
        </select>

        <button class="delete" onclick="deleteOrder('${d.id}')">
          Delete Order
        </button>
      </div>
    `;
  });

  document.getElementById("liveCount").innerText =
  `ðŸ“¦ Total: ${total} | âœ… Delivered: ${delivered} | ðŸŸ¡ Pending: ${total-delivered}`;

});
window.updateStatus = async(id,status)=>{
  await updateDoc(doc(db,"orders",id),{status});
};

let deleteId = null;

window.deleteOrder = function(id){
  deleteId = id;
  document.getElementById("deleteModal").style.display = "flex";
}

window.closeDeleteModal = function(){
  document.getElementById("deleteModal").style.display = "none";
  deleteId = null;
}

window.confirmDelete = async function(){
  if(deleteId){
    await deleteDoc(doc(db,"orders",deleteId));
    closeDeleteModal();
  }
}

window.logout = function(){
  sessionStorage.clear();
  window.location.replace("login.html");
}

</script>
<!-- DELETE CONFIRM MODAL -->
<div id="deleteModal" class="modal">
  <div class="modal-card">
    <h3>Delete Order?</h3>
    <p>Are you sure</p>

    <div class="modal-actions">
      <button class="cancel-btn" onclick="closeDeleteModal()">Cancel</button>
      <button class="danger-btn" onclick="confirmDelete()">Delete</button>
    </div>
  </div>
</div>
</body>
</html>
